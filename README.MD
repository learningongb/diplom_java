# Телеграм-бот для удаленного просмотра заметок Obsidian на сервере

## Описание сценария использования

На сервере хранятся заметки Obsidian. Заметки синхронизируются с локальным компьютером пользователя. Это можно делать любым удобным способом, например, с использованием git.  
На локальном компьютере заметки можно редактировать и просматривать с помощью приложения от Obsidian. Оно бесплатно для домашнего использования. Но для установки на рабочем компьютере необходимо покупать лицензию. Кроме того, возникает необходимость просмотра заметок с мобильного телефона.  
В качестве решения был разработан телеграм-бот, который предоставляет доступ к заметкам.  
Доступ разрешен не всем пользователям, а только тем, которые прописаны в настройках приложения, в файле `application.yaml`.  
Доступ настраивается по идентификатору клиента telegram.  
У каждого пользователя свой набор доступных каталогов, поэтому разные пользователи не видят заметки других пользователей.

## Возможности приложения

- Просмотр списка заметок пользователя
- Просмотр списка тэгов, используемых в заметках
- Вывод списка заметок
- Вывод списка заметок по тэгу
- Поиск заметок по тексту
- Просмотр заметки

## Формат заметок Obsidian

Заметки Obsidian - это простые текстовые файлы в формате markdown.
В заметке может присутствовать секция свойств, в которой указаны тэги для заметки.
Секция начинается с строкой --- и заканчивается строкой ---.  
Например,
>\---  
>tags:  
> \- tag1  
> \- tag2  
>\---

## Использование бота

При запуске бота он выводит приветствие, читает список заметок пользователя и выводит список команд бота. Каждой заметке присваивается номер, по которому можно открыть заметку. При обновлении списка обновляются номера заметок. Обновление списка производится при каждом выводе списка всех заметок.
Для удобства команды бота выводятся в виде кнопок.

### Команды бота

- `/ln` (List Notes) - выводит список заметок. 
- `/lt` (List Tags) - выводит список тэгов.
- `/f` (Find) - поиск заметки по тексту.
- `/t` (find by Tag) - поиск заметок по тэгу.

#### Вывод список заметок - команда /ln

Обновляет список заметок и выводит иерархический список. Каждая заметка имеет свой номер, который используется для просмотра заметок.

#### Вывод список тэгов - команда /lt

Выводит список тэгов, использующихся в заметках.

#### Поиск заметки по тексту - команда /f

После ввода команды бот ожидает ввод текста для поиска. После отправки текста выполняется поиск и выводится плоский список заметок, содержащих искомый текст в заголовке или содержимом заметки.

#### Поиск заметок по тэгу - команда /t

После ввода команды бот выводит список тэгов и ожидает ввода тэга для поиска.  
Тэги на латинице можно нажать в списке тэегов и они автоматически используются как тэг для поиска.  
Тэги на кирилице необходимо вводить вручную.  
В результате выводится плоский список заметок, содержащих указанный тэг.  
Номера заметок совпадают с номерами заметок в иерархическом списке заметок.

#### Открытие заметки

Если бот не находится в состоянии ожидания тэга для поиска или текста для поиска, то можно ввести номер заметки, которую нужно открыть.  
Если заметки с таким номером нет или введен номер меньше 1, то бот не выводит заметку.  
Вывод заметки выполняется в формате markdown. При выводе может возникнуть исключение, связанное с недопустимыми символами в markdown telegram'a. В этом случае заметка будет выведена в текстовом формате, без форматирования.  
Вывод заметки выполняется без конвертации в формат markdown, который используется в telegram. Он немного отличается от стандартного и поэтому внешний вид заметки может отличаться от ее представления в приложении Obsidian.


## Устройство бота

Бот реализован с использованием `Spring Boot`.  
Для работы с telegram используется `telegrambots-spring-boot-starter`. Конфигурация бота устанавливается в классе `TgBotConfiguration`. В классе устанавливается токен бота и его имя. Токен может быть установлен в ключе `bot.token` или в файле `botcredentials.env`. Если токен не задан, то приложение завершает работу.  
Бот реализован на основе конечного автомата.

### Настройка данных и авторизация пользователя

В файле конфигурации допустные пользователю директории указываются в ключе `users.xxxxxxxxx`, где `xxxxxxxxx` - идентификатор пользователя telegram. Узнать пользователя можно в логах приложения.  
При подключении пользователя проверяется список доступных директорий. Если для пользователя не прописаны директории, то доступ к боту не предоставляется.

### Описание конечного автомата бота

| Начальное состояние | Триггер | Действие | Конечное состояние |
| ---- | ---- | ---- | ---- |
| START | START | Обновить список заметок. | MAIN_MENU |
| MAIN_MENU | HELP |  | MAIN_MENU |
| MAIN_MENU | LIST_NOTES | Обновить список заметок.<br>Вывести список заметок. | MAIN_MENU |
| MAIN_MENU | OPEN_NOTE | Открыть заметку с номером | MAIN_MENU |
| MAIN_MENU | FIND_NOTES | Запросить текст поиска | FIND_NOTES |
| FIND_NOTES | ENTER_SEARCH _STRING | Вывести список заметок | MAIN_MENU |
| MAIN_MENU | FIND_TAGS | Запросить текст поиска | FIND_TAGS |
| FIND_TAGS | ENTER_SEARCH _STRING_TAG | Вывести список | MAIN_MENU |
| MAIN_MENU | LIST_TAGS | Вывести список тэгов | MAIN_MENU |

